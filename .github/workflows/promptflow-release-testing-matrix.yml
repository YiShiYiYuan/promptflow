name: promptflow-release-testing-matrix
on:
  push:
    branches:
      - v1.16.2_vision
  workflow_call:
  workflow_dispatch:
    inputs:
      # can leave empty when trigger manually
      # GitHub Actions API for trigger does not return workflow run id
      # there we reference below Stack Overflow solution:
      # https://stackoverflow.com/a/69500478
      # which adds an identifier in workflow run jobs and can be used for filter
      id:
        description: Identifier for the workflow run
        required: false
        type: string
env:
  IS_IN_CI_PIPELINE: "true"
  TRACING_DIRECTORY: ${{ github.workspace }}/src/promptflow-tracing
  AZURE_DIRECTORY: ${{ github.workspace }}/src/promptflow-azure
  CORE_DIRECTORY: ${{ github.workspace }}/src/promptflow-core
  DEVKIT_DIRECTORY: ${{ github.workspace }}/src/promptflow-devkit
  PROMPTFLOW_DIRECTORY: ${{ github.workspace }}/src/promptflow
  TOOL_DIRECTORY: ${{ github.workspace }}/src/promptflow-tools
  RECORD_DIRECTORY: ${{ github.workspace }}/src/promptflow-recording
  PROMPT_FLOW_WORKSPACE_NAME: "promptflow-eastus"

permissions:
  id-token: write
  contents: write

jobs:
  id:
    runs-on: ubuntu-latest
    steps:
      - name: workflow run id - ${{ inputs.id }}
        run: |
          echo "workflow run id: ${{ inputs.id }}"
  build:
    runs-on: ubuntu-latest
    steps:
    - name: checkout
      uses: actions/checkout@v4
    - uses: actions/setup-python@v5
      with:
        python-version: "3.9"
    - uses: snok/install-poetry@v1
    - working-directory: ${{ env.TRACING_DIRECTORY }}
      run: poetry build -f wheel
    - working-directory: ${{ env.CORE_DIRECTORY }}
      run: poetry build -f wheel
    - working-directory: ${{ env.DEVKIT_DIRECTORY }}
      run: poetry build -f wheel
    - working-directory: ${{ env.AZURE_DIRECTORY }}
      run: poetry build -f wheel
    - working-directory: ${{ env.PROMPTFLOW_DIRECTORY }}
      run: |
        pip install -r ./dev_requirements.txt
        python ./setup.py bdist_wheel
    - working-directory: ${{ env.TOOL_DIRECTORY }}
      run: python ./setup.py bdist_wheel
    - working-directory: ${{ github.workspace }}
      run: |
        rm -fr *.whl
        cp ${{ github.workspace }}/src/*/dist/*.whl ./
        tar -czvf promptflow-dist.tar.gz *.whl
        ls -al
    - name: Get version
      id: get_version
      run: |
        VERSION=$(date +%Y.%m.%d)
        echo "VERSION=${VERSION}" >> $GITHUB_ENV
    - name: Upload Wheel
      uses: actions/upload-artifact@v4
      with:
        name: wheel
        path: ${{ github.workspace }}/*.whl
    - name: Delete existing release and tag if found
      run: |
        VERSION="v${{ env.VERSION }}"

        if gh release view "$VERSION" > /dev/null 2>&1; then
          echo "Release $VERSION exists. Deleting release..."
          gh release delete "$VERSION" --yes
        else
          echo "Release $VERSION does not exist."
        fi
        
        if git rev-parse "$VERSION" >/dev/null 2>&1; then
          echo "Tag $VERSION exists locally. Deleting tag..."
          git tag -d "$VERSION" || true
        else
          echo "Tag $VERSION does not exist locally."
        fi

        if git ls-remote --tags origin | grep "refs/tags/$VERSION" >/dev/null 2>&1; then
          echo "Tag $VERSION exists on remote. Deleting remote tag..."
          git push origin :refs/tags/"$VERSION" || true
        else
          echo "Tag $VERSION does not exist on remote."
        fi
    - name: Release
      uses: softprops/action-gh-release@v2
      with:
        name: 'Vision branch v${{ env.VERSION }}'
        tag_name: 'v${{ env.VERSION }}'
        make_latest: true
        body: |
          Reinstall promptflow with the following command:
          ```bash
          pip uninstall -y promptflow promptflow-tracing promptflow-core promptflow-devkit promptflow-azure promptflow-rag promptflow-evals promptflow-tools
          pip install promptflow-1.16.2-py3-none-any.whl promptflow_core-1.17.0.dev0-py3-none-any.whl promptflow_devkit-1.17.0.dev0-py3-none-any.whl  promptflow_tools-1.4.0-py3-none-any.whl promptflow_azure-1.17.0.dev0-py3-none-any.whl  promptflow_tracing-1.17.0.dev0-py3-none-any.whl
          ```
        files: |
          ${{ github.workspace }}/*.whl
          ${{ github.workspace }}/promptflow-dist.tar.gz
